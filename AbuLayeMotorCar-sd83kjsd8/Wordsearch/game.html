<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EN‚ÜîRU Word Search ‚Äî v4 (No Theme)</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet" />

<style>
:root{
  --gridgap:4px; /* layout constant */
}

/* ===== Global Styles ===== */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Baloo 2",cursive;
  /* Funky permanent gradient background */
  background:linear-gradient(135deg,#ff6ec4 0%, #7873f5 25%, #42e695 50%, #fdfc47 75%, #fa709a 100%);
  background-size:cover;
  background-attachment:scroll;
  color:#0f172a;
  min-height:100svh;
}

.wrap{
  width:100%;
  max-width:1120px;
  margin:0 auto;
  padding:14px 16px;
}

header{
  position:sticky;
  top:0;
  background:#ffffffee;
  backdrop-filter:saturate(140%) blur(10px);
  border-bottom:1px solid #e5e7eb;
  z-index:10;
  isolation:isolate;
}
header::before{
  content:"";
  position:fixed;
  inset:0 0 auto 0;
  height:var(--header-h, 64px);
  z-index:-1;
}

/* ===== Toolbar / Hamburger ===== */
.toolbar-header{display:flex; align-items:center; gap:12px}
.menu-btn{
  background:none; border:none; font-size:1.9rem; line-height:1; cursor:pointer; color:#0f172a;
  display:none;
}
.toolbar{
  display:flex; gap:12px; flex-wrap:wrap; align-items:center;
  transition:max-height .3s ease, opacity .3s ease; width:100%;
  justify-content: center;
}
.toolbar > *{margin:4px 0}
.toolbar.collapsed{max-height:0; opacity:0; overflow:hidden; pointer-events:none}


.status-bar{
  display:none;
}





/* ===== Controls ===== */
select,
button{
  appearance:none;
  border:1px solid #dbeafe;
  background:#ffffff;
  color:#0f172a;
  padding:10px 12px;
  border-radius:12px;
  font-weight:700;
  box-shadow:0 2px 0 #e5e7eb inset;
  transition:transform .06s ease, box-shadow .2s ease;
}
button.primary{
  background:#00BBF9;
  border-color:#00BBF9;
  color:#fff;
}
button.ghost{
  background:#ffffff;
  color:#0f172a;
}
button:hover, select:hover{ box-shadow:0 0 0 3px #9B5DE555 inset; }
button:active{ transform:translateY(1px); }
button:disabled{ opacity:.6; }

.stats{
  display:flex;
  gap:14px;
  color:#64748b;
  font-weight:700;
}

/* Hint button */
.hint-btn{
  position:absolute;
  top:12px;
  right:12px;
  z-index:2;
  border:1px solid #dbeafe;
  background:#ffffff;
  color:#0f172a;
  padding:8px 12px;
  border-radius:12px;
  font-weight:700;
  box-shadow:0 2px 0 #e5e7eb inset;
  transition:transform .06s ease, box-shadow .2s ease;
  cursor:pointer;
}
.hint-btn:hover{ box-shadow:0 0 0 3px #9B5DE555 inset; }
.hint-btn:active{ transform:translateY(1px); }

/* ===== Layout ===== */
main{
  width:100%;
  max-width:1120px;
  margin:18px auto;
  padding:0 16px;
  display:grid;
  grid-template-columns:minmax(260px, 360px) 1fr;
  gap:18px;
}

.panel{
  position:relative;
  width:100%;
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:20px;
  padding:16px;
  box-shadow:0 6px 24px rgba(0,0,0,.06);
  overflow:hidden;
}
.panel h2{
  margin:6px 0 10px;
  font-size:24px;
  text-align:center;
  font-weight:700;
}

/* ===== Clues ===== */
.clue-list{list-style:none; margin:0; padding:0; display:grid; gap:8px}
.clue {
  padding: 10px 12px;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: #ffffff;
  position: relative;
  overflow: hidden;
  text-align:left;
}
.clue.found{opacity:.75; text-decoration:line-through}
.legend{color:#64748b; font-size:12px; margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
.dot{width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 1px #e5e7eb; display:inline-block}

/* ===== Grid ===== */
.grid{
  user-select:none;
  -webkit-user-select:none;
  touch-action:none;
  display:grid;
  gap:var(--gridgap);
  background:#ffffff;
  border:3px solid #00BBF9;
  border-radius:20px;
  padding:calc(var(--gridgap) * 2);
  box-shadow:inset 0 1px 0 #f1f5f9;
  width:fit-content;
  max-width:100%;
  margin:0 auto;
}

.cell{
  width:34px; height:34px;
  display:grid; place-items:center;
  font-weight:800; letter-spacing:.5px;
  text-transform:lowercase;
  cursor:pointer;
  border-radius:8px;
  transition:transform .07s ease, background .15s ease, color .15s ease;
  color:#111827;
  background:#ffffff;
  line-height: 1;
  overflow: hidden;
  touch-action: none;           /* NEW: ensure dragging isn‚Äôt turned into scrolling/zoom */
}


.cell:hover{outline:2px solid #e0f2fe;}
.cell[data-sel="1"]{background:#f1f5f9}
.cell[data-word="1"]{background:#dbeafe}
.cell[data-found="1"]{background:#dbeafe; color:#0b0f19}
.cell.pop{animation:pop .28s ease}
@keyframes pop{50%{transform:scale(1.12)} 100%{transform:none}}

.modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.18); padding:20px}
.modal.show{display:grid}
.modal .box{background:#fff; border-radius:16px; padding:20px; width:min(520px,92vw); border:1px solid #eee}
.box h3{margin:0 0 10px}

.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; color:#312e81;
      border-radius:999px; font-weight:700; font-size:12px}
.hint-flash{animation:hintBlink .6s ease-in-out 0s 3}
@keyframes hintBlink{50%{transform:scale(1.12)} 100%{transform:none}}

/* ===== Mobile: swipable one-at-a-time clues ===== */
@media (max-width: 768px){




  /* Show the hamburger on small screens */
  .menu-btn{
    display: inline-block;          /* was display:none globally */
  }

  /* (Optional) nicer open animation when JS adds .open */
  .toolbar.open{
    max-height: 600px;
    opacity: 1;
    pointer-events: auto;
  }
  main{ grid-template-columns: 1fr; gap:12px; }

    /* Make list a swipeable carousel that shows 2‚Äì3 per view */
  #clues{
    --slides: 2;              /* JS will update this to 2 or 3 */
    --gap: 8px;               /* visual gap between items */
    display:flex;
    gap: var(--gap);
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type:x mandatory;
    scroll-behavior: smooth;
    padding:0;
    margin:0;
    touch-action: pan-x;
    scrollbar-width: none;
  }
  #clues::-webkit-scrollbar{ display:none; }

  /* Each slide takes 1/(slides) of width, accounting for gaps */
  .clue{
    flex: 0 0 calc((100% - (var(--gap) * (var(--slides) - 1))) / var(--slides));
    min-width: calc((100% - (var(--gap) * (var(--slides) - 1))) / var(--slides));
    justify-content:center;
    text-align:center;
    height:64px;
    font-size:clamp(18px, 5.2vw, 26px);
    scroll-snap-align:center;
    border-width:2px;
    border-radius:16px;
  }

  /* Hide the colored dot; center just the label */
  .clue .dot{ display:none; }
  .clue [data-role="label"]{
    margin:0 !important;
    display:inline-block;
  }

  /* Save vertical space */
  .legend{ display:none; }


}

/* Mobile header layout (burger | words-left centered | timer right) */
@media (max-width: 768px){
  /* Make the header a 2-col grid: [hamburger] [status area] */
  .toolbar-header{
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: center;
    gap: 8px;
  }

  /* Status area sits in column 2 and itself is a 2-col grid */
  #statusBar{
    grid-column: 2;
    display: grid;
  }
  #statusBar .stats{
    display: flex;
    justify-content: flex-end;
    grid-template-columns: 1fr auto;    /* [centered words-left] [timer right] */
    align-items: center;
    width: 100%;
  }
  /* ‚úÖ found/goal centered in the whole header */
  #statusBar .stats > span:nth-child(2){
    grid-column: 1;
    justify-self: center;
  }
  /* ‚è±Ô∏è timer pinned to the right edge */
  #statusBar .stats > span:nth-child(1){
    grid-column: 2;
    justify-self: end;
  }

  /* Put the collapsible toolbar (buttons/selects) on the next row */
  .toolbar{
    grid-column: 1 / -1;
  }
}



</style>
</head>
<body>

<header>
  <div class="wrap toolbar-header">
   <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="false" aria-controls="toolbar">‚ò∞</button>

<!-- NEW: always-visible status strip on mobile -->
<div id="statusBar" class="status-bar" aria-live="polite"></div>

<div id="toolbar" class="toolbar" aria-label="Toolbar">

      <button id="newGame" class="primary">New Game</button>
      <label>Difficulty
        <select id="difficulty">
          <option value="lvl1">Level 1</option>
          <option value="lvl2">Level 2</option>
          <option value="lvl3">Level 3</option>
          <option value="lvl4">Level 4</option>
          <option value="lvl5">Level 5</option>
        </select>
      </label>
      <label>Clues
        <select id="clueSide">
          <option value="en">English ‚Üí Find Roman Urdu</option>
          <option value="ru">Roman Urdu ‚Üí Find English</option>
        </select>
      </label>
      <button id="toggleTimer" class="ghost">Timer: On</button>
      <div class="stats" role="status" aria-live="polite">
        <span>‚è±Ô∏è <b id="time">0:00</b></span>
        <span>‚úÖ <b id="foundCount">0</b>/<b id="goalCount">0</b></span>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="panel" aria-labelledby="clueHeader">
    <h2 id="clueHeader">Clues</h2>
    <div class="legend" id="legend"></div>
    <ul id="clues" class="clue-list"></ul>
  </section>

  <section class="panel" aria-labelledby="gridHeader">
    <button id="hintBtn" class="hint-btn" title="Flash starting letters (+10s)" aria-label="Hint">Hint</button>
    <h2 id="gridHeader">Word Grid</h2>
    <div id="grid" class="grid" aria-label="Word search grid"></div>
  </section>
</main>

<div id="winModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle">
  <div class="box">
    <h3 id="winTitle">Great job! üéâ</h3>
    <p>You found all the words.</p>
    <p>
      <span class="pill">Time: <span id="finalTime">0:00</span></span>
      <span class="pill">Words: <span id="finalWords">0</span></span>
    </p>
    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button id="playAgain" class="primary">Play again</button>
      <button id="closeModal" class="ghost">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { riddles } from "../vocab.js";

/* ===================== Config ===================== */
const WORDS = riddles
  .filter(r => r.word && r.word.english && r.word.romanUrdu)
  .map(r => ({ en: r.word.english.trim(), ru: r.word.romanUrdu.trim() }));

const GRID_SIZES = { lvl1: 10, lvl2: 11, lvl3: 13, lvl4: 15, lvl5: 17 };
const FRACTIONS  = { lvl1: 1/5, lvl2: 2/5, lvl3: 3/5, lvl4: 4/5, lvl5: 1 };
const DIRECTIONS = [
  { dx: 1, dy: 0 }, { dx: 0, dy: 1 }, { dx: 1, dy: 1 }, { dx:-1, dy: 1 },
];
const MAX_ATTEMPTS = 2500;
const PALETTE = ["#9B5DE5","#F15BB5","#FEE440","#00BBF9","#00F5D4"];

let state = {
  rows: 10, cols: 10, grid: [],
  wordsPlaced: [], selection: [], isDragging:false, startCell:null,
  found: new Set(), timerOn: true, t0: 0, tId: null,
  clueSide: 'en', difficulty: 'lvl3',
};

/* ===== Utility Functions ===== */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const rand = n => Math.floor(Math.random()*n);
const choice = arr => arr[rand(arr.length)];
const letters = 'abcdefghijklmnopqrstuvwxyz';
const norm = s => (s||'').toLowerCase().replace(/[^a-z]/g,'');
const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
const fmtTime = s => { const m = Math.floor(s/60), r = s%60; return `${m}:${r.toString().padStart(2,'0')}`; };

/* Timer */
function startTimer(){ state.t0 = Date.now(); stopTimer(); if(!state.timerOn){ qs('#time').textContent='0:00'; return; } state.tId=setInterval(()=>{ const sec=Math.floor((Date.now()-state.t0)/1000); qs('#time').textContent=fmtTime(sec); }, 500); }
function stopTimer(){ if(state.tId){ clearInterval(state.tId); state.tId=null; } }
function addPenalty(seconds=10){ state.t0 -= seconds*1000; }

/* Grid + Word Placement Helpers */
function makeGrid(rows, cols){ return Array.from({length:rows},()=>Array.from({length:cols},()=>null)); }
function inBounds(r,c){ return r>=0 && c>=0 && r<state.rows && c<state.cols; }
function canPlace(grid, word, r,c, dir){
  for(let i=0;i<word.length;i++){
    const rr=r+dir.dy*i, cc=c+dir.dx*i;
    if(!inBounds(rr,cc)) return false;
    const cell = grid[rr][cc];
    if(cell && cell!==word[i]) return false;
  }
  return true;
}
function placeWord(grid, word, r,c, dir){
  const cells=[];
  for(let i=0;i<word.length;i++){
    const rr=r+dir.dy*i, cc=c+dir.dx*i;
    grid[rr][cc]=word[i];
    cells.push({r:rr,c:cc});
  }
  return cells;
}

function layoutWords(rawPairs){
  const grid = makeGrid(state.rows, state.cols);
  const placed = [];
  const pairs = [...rawPairs].sort((a,b)=>norm(b.target).length - norm(a.target).length);

  for(const p of pairs){
    const target = norm(p.target);
    if(!target || target.length<2) continue;

    let attempts=0, ok=false;
    while(attempts++<MAX_ATTEMPTS){
      const dir = choice(DIRECTIONS); const r = rand(state.rows); const c = rand(state.cols);
      if(canPlace(grid, target, r, c, dir)) {
        const cells=placeWord(grid,target,r,c,dir);
        placed.push({ id:p.id, text:target, show:p.show, clue:p.clue, color:p.color, cells });
        ok=true; break;
      }
    }
    if(!ok){
      outer: for(const dir of DIRECTIONS){
        for(let r=0;r<state.rows;r++){
          for(let c=0;c<state.cols;c++){
            if(canPlace(grid,target,r,c,dir)){
              const cells=placeWord(grid,target,r,c,dir);
              placed.push({ id:p.id, text:target, show:p.show, clue:p.clue, color:p.color, cells });
              ok=true; break outer;
            }
          }
        }
      }
    }
  }

  for(let r=0;r<state.rows;r++){
    for(let c=0;c<state.cols;c++){
      if(!grid[r][c]) grid[r][c] = letters[rand(letters.length)];
    }
  }
  return {grid, placed};
}

/* Build Puzzle */
function buildPuzzle(){
  state.difficulty = qs('#difficulty').value;
  state.clueSide   = qs('#clueSide').value;
  state.rows = state.cols = GRID_SIZES[state.difficulty];

  const frac = FRACTIONS[state.difficulty];
  const N = Math.max(6, Math.round(WORDS.length * frac));
  const chosen = shuffle([...WORDS]).slice(0, Math.min(N, WORDS.length));

  const pairs = chosen.map((w,idx)=>{
    const show   = state.clueSide==='en' ? w.ru : w.en;
    const clue   = state.clueSide==='en' ? w.en : w.ru;
    const color  = PALETTE[idx % PALETTE.length];
    return { id: idx+'_'+Date.now(), show, clue, target: show, color };
  });

  const {grid, placed} = layoutWords(pairs);
  state.grid = grid; state.wordsPlaced = placed; state.found = new Set();

    renderGrid();
  renderClues();
  setupClueCarousel(); // <‚Äî added


  qs('#goalCount').textContent = String(state.wordsPlaced.length);
  qs('#foundCount').textContent = '0';
  qs('#legend').innerHTML = state.clueSide==='en'
    ? '<span class="pill">Clues: English</span><span class="pill">Find: Roman Urdu</span>'
    : '<span class="pill">Clues: Roman Urdu</span><span class="pill">Find: English</span>';

  startTimer();
}

/* Render Clues (desktop list + mobile carousel) */
function renderClues(){
  const ul = qs('#clues'); ul.innerHTML='';
  for(const w of state.wordsPlaced){
    const li = document.createElement('li');
    li.className='clue';
    li.dataset.id = w.id;
    li.style.boxShadow = `inset 6px 0 0 ${w.color}66`;

    const dot   = document.createElement('span');
    dot.className='dot';
    dot.style.background = w.color;

    const label = document.createElement('span');
    label.textContent = w.clue;
    label.style.marginLeft='6px';
    label.setAttribute('data-role','label');   // <-- used by mobile CSS

    const leftWrap = document.createElement('span');
    leftWrap.style.display='inline-flex';
    leftWrap.style.alignItems='center';
    leftWrap.append(dot,label);

    li.append(leftWrap);
    li.addEventListener('click', (ev)=> { 
  ev.stopPropagation();           // don‚Äôt toggle pause when tapping a clue
  flashFirstCell(w.id); 
});

    ul.appendChild(li);
  }
}


/* ===== Mobile Clue Carousel: auto-scroll + tap to pause + swipe ===== */
let autoScrollId = null;
let carouselPaused = false;
let slidesPerView = 2;

function applySlidesPerView(){
  const ul = qs('#clues'); 
  if(!ul) return;
  // 2 per view for narrow phones, 3 if a bit wider (still <=768px)
  const w = ul.clientWidth;
  slidesPerView = (w >= 560 ? 3 : 2);
  ul.style.setProperty('--slides', String(slidesPerView));
}

function scrollNextClue(){
  const ul = qs('#clues'); 
  if(!ul) return;
  const amount = Math.round(ul.clientWidth / slidesPerView);
  ul.scrollBy({ left: amount, behavior: 'smooth' });
}

function startClueAuto(){
  if(window.innerWidth > 768) return;      // only mobile auto-scroll
  stopClueAuto();
  autoScrollId = setInterval(scrollNextClue, 2200); // speed
}

function stopClueAuto(){
  if(autoScrollId){
    clearInterval(autoScrollId);
    autoScrollId = null;
  }
}

function setCarouselPaused(p){
  carouselPaused = p;
  if(p) stopClueAuto(); else startClueAuto();
}

function onCluesClickToggle(){
  if(window.innerWidth > 768) return;
  setCarouselPaused(!carouselPaused); // tap to pause/resume
}

function onCluesPointerDown(){ 
  if(window.innerWidth > 768) return;
  setCarouselPaused(true); // any drag/touch pauses auto
}

function onCluesWheel(){
  if(window.innerWidth > 768) return;
  setCarouselPaused(true); // wheel also pauses
}

function setupClueCarousel(){
  const ul = qs('#clues'); 
  if(!ul) return;

  applySlidesPerView();

  // Ensure single listeners (remove then add)
  ul.removeEventListener('click', onCluesClickToggle);
  ul.removeEventListener('pointerdown', onCluesPointerDown);
  ul.removeEventListener('wheel', onCluesWheel);

  ul.addEventListener('click', onCluesClickToggle);
  ul.addEventListener('pointerdown', onCluesPointerDown, { passive:true });
  ul.addEventListener('wheel', onCluesWheel, { passive:true });

  // Start/stop auto based on viewport
  if(window.innerWidth <= 768){
    setCarouselPaused(false); // auto-run initially on mobile
  }else{
    setCarouselPaused(true);  // never auto on desktop
  }
}



function renderGrid(){
  const g = qs('#grid');
  g.innerHTML = '';

  // Compute available width inside the panel (minus padding)
  const panel = g.closest('.panel');
  const panelStyles = getComputedStyle(panel);
  const panelInnerWidth =
    panel.clientWidth
    - parseFloat(panelStyles.paddingLeft)
    - parseFloat(panelStyles.paddingRight);

  // Grid own padding/gap/border
  const gs = getComputedStyle(g);
  const gap = parseFloat(gs.gap) || 4;
  const paddingX =
    (parseFloat(gs.paddingLeft) || 0) + (parseFloat(gs.paddingRight) || 0);
  const borderX = 6; // 3px left + 3px right

  // Width available for the cells themselves (subtract gaps between columns)
  const cellsBand =
    panelInnerWidth - paddingX - borderX - gap * (state.cols - 1);

  // Final cell size (min 24px for readability)
  const cell = Math.max(24, Math.floor(cellsBand / state.cols));

  // Lock columns and rows so boxes are perfect squares
  g.style.gridTemplateColumns = `repeat(${state.cols}, ${cell}px)`;
  g.style.gridAutoRows = `${cell}px`;

  for(let r=0; r<state.rows; r++){
    for(let c=0; c<state.cols; c++){
      const d = document.createElement('div');
      d.className = 'cell';

      // Size the box
      d.style.width = d.style.height = `${cell}px`;

      // Safe font sizing for Baloo 2 @ 800 weight
      d.style.fontSize = `${Math.max(12, Math.floor(cell * 0.52))}px`;
      d.style.lineHeight = '1';

      d.dataset.r = r;
      d.dataset.c = c;
      d.textContent = state.grid[r][c];

      d.addEventListener('pointerdown', onStart);
      d.addEventListener('pointerenter', onMove);
      d.addEventListener('pointerup', onEnd);

      g.appendChild(d);
    }
  }

    g.addEventListener('pointerleave', () => state.isDragging && clearSelection());
  g.addEventListener('pointermove', onMove, { passive: true }); // NEW: track drag on touch

}

/* Interaction */
function cellAt(ev){
  const el = ev.target.closest('.cell');
  if(!el) return null;
  return { el, r:+el.dataset.r, c:+el.dataset.c };
}
function onStart(ev){
  ev.preventDefault();
  const cell = cellAt(ev); if(!cell) return;
  state.isDragging = true; state.selection = [cell]; state.startCell = cell;
  markSelected();
}
function onMove(ev){
  if(!state.isDragging) return;
  const cell = cellAt(ev); if(!cell) return;
  const a = state.startCell; const b = cell;
  const dr = b.r - a.r, dc = b.c - a.c;
  const adR = Math.abs(dr), adC = Math.abs(dc);
  if(!(adR===0 || adC===0 || adR===adC)) return;
  const stepR = Math.sign(dr), stepC = Math.sign(dc);
  const len = Math.max(adR, adC);
  const path=[]; for(let i=0;i<=len;i++){ path.push({ r:a.r+i*stepR, c:a.c+i*stepC }); }
  for(const p of path){ if(!inBounds(p.r,p.c)) return; }
  state.selection = path.map(p=>({ el: document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`), r:p.r, c:p.c }));
  markSelected();
}
function onEnd(){
  if(!state.isDragging) return;
  state.isDragging=false;
  checkSelection();
  clearSelection();
}

function markSelected(){
  qsa('.cell').forEach(el=> el.dataset.sel='0');
  for(const s of state.selection){ s.el.dataset.sel='1'; }
}
function clearSelection(){ qsa('.cell').forEach(el=> el.dataset.sel='0'); state.selection=[]; state.startCell=null; }

/* Move a found clue to the end of the list (for mobile carousel) */
function moveClueToEnd(wordId){
  const li = document.querySelector(`.clue[data-id="${wordId}"]`);
  if(li && li.parentElement){
    li.parentElement.appendChild(li);
  }
}

function checkSelection(){
  if(state.selection.length<2) return;
  const lettersSel = state.selection.map(s=> state.grid[s.r][s.c]).join('');
  const hit = state.wordsPlaced.find(w=> !state.found.has(w.id) && lettersSel===w.text);
  if(!hit) return;

  state.found.add(hit.id);

  // Color the path
  for(const s of state.selection){
    s.el.dataset.found='1'; s.el.dataset.word='1';
    s.el.style.background = hit.color; s.el.style.color = '#0b0f19';
    s.el.classList.add('pop'); setTimeout(()=>s.el.classList.remove('pop'), 300);
  }

  // Strike the clue and move to end on mobile
  const li = document.querySelector(`.clue[data-id="${hit.id}"]`);
  if(li){
    li.classList.add('found');
    li.style.background = hit.color;
    li.style.borderColor = hit.color;
    li.style.color = '#0b0f19';
    if(window.innerWidth <= 768){
      moveClueToEnd(hit.id);
    }
  }

  qs('#foundCount').textContent = String(state.found.size);

  if(state.found.size === state.wordsPlaced.length){
    stopTimer();
    qs('#finalTime').textContent = qs('#time').textContent;
    qs('#finalWords').textContent = String(state.found.size);
    qs('#winModal').classList.add('show');
  }
}

function flashFirstCell(wordId){
  const w = state.wordsPlaced.find(x=> x.id===wordId);
  if(!w) return;
  const first = w.cells[0];
  const el = document.querySelector(`.cell[data-r="${first.r}"][data-c="${first.c}"]`);
  if(el){ el.classList.add('hint-flash'); setTimeout(()=> el.classList.remove('hint-flash'), 1600); }
}

/* Menu toggle */
const toolbar = qs('#toolbar');
const menuToggle = qs('#menuToggle');
function setMenu(open){
  if(open){
    toolbar.classList.add('open');
    toolbar.classList.remove('collapsed');
    menuToggle.setAttribute('aria-expanded','true');
    menuToggle.textContent = '‚úï';
  }else{
    toolbar.classList.remove('open');
    toolbar.classList.add('collapsed');
    menuToggle.setAttribute('aria-expanded','false');
    menuToggle.textContent = '‚ò∞';
  }
}
menuToggle.addEventListener('click', ()=>{
  const open = !toolbar.classList.contains('open');
  setMenu(open);
});


/* ===== Mobile status bar relocation ===== */
function relocateStats(){
  const toolbar = qs('#toolbar');
  const statusBar = qs('#statusBar');
  const stats = qs('.stats'); // existing stats div with #time/#foundCount/#goalCount
  if(!stats || !toolbar || !statusBar) return;

  if(window.innerWidth <= 768){
    // Move stats into status bar if not already there
    if(!statusBar.contains(stats)) statusBar.appendChild(stats);
  }else{
    // Move stats back into toolbar on desktop
    if(!toolbar.contains(stats)) toolbar.appendChild(stats);
  }
}

/* Controls */
qs('#newGame').addEventListener('click', ()=>{
  buildPuzzle();
  if(window.innerWidth <= 768){ setMenu(false); }
});
qs('#difficulty').addEventListener('change', buildPuzzle);
qs('#clueSide').addEventListener('change', buildPuzzle);
qs('#hintBtn').addEventListener('click', ()=>{
  addPenalty(10);
  for(const w of state.wordsPlaced){ if(!state.found.has(w.id)) flashFirstCell(w.id); }
});
qs('#toggleTimer').addEventListener('click', (e)=>{
  const wasOn = state.timerOn;
  state.timerOn = !state.timerOn;
  e.target.textContent = `Timer: ${state.timerOn ? 'On' : 'Off'}`;

  // If turning ON, restart with a new puzzle using current settings
  if (!wasOn && state.timerOn) {
    buildPuzzle();
  } else {
    startTimer(); // just update timer display if toggled off
  }
});

qs('#playAgain').addEventListener('click', ()=>{ qs('#winModal').classList.remove('show'); buildPuzzle(); });
qs('#closeModal').addEventListener('click', ()=>{ qs('#winModal').classList.remove('show'); });

(function init(){
  qs('#difficulty').value = 'lvl1';
  if (window.innerWidth <= 768) {
    setMenu(false);
  } else {
    toolbar.classList.remove('collapsed', 'open');
    menuToggle.textContent = '‚ò∞';
    menuToggle.setAttribute('aria-expanded', 'false');
  }
  buildPuzzle();
    relocateStats();  

  // Rescale letters/cells on resize; keeps carousel width and grid sizing correct
 window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    toolbar.classList.remove('collapsed', 'open');
    menuToggle.textContent = '‚ò∞';
    menuToggle.setAttribute('aria-expanded', 'false');
  } else {
    setMenu(false);
  }

  relocateStats();  // NEW: keep stats in statusBar on mobile, toolbar on desktop

  applySlidesPerView();                            // existing
  if(window.innerWidth <= 768 && !carouselPaused){ // existing
    startClueAuto();
  }else{
    stopClueAuto();
  }
  renderGrid(); // existing

  // NEW: ensure we end selection even if finger lifts off a different element
  window.addEventListener('pointerup', onEnd, { passive: true });

});

})();
</script>
</body>
</html>
